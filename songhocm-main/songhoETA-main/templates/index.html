<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì†¡í˜¸ ETA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <style>
    body {
      background-image: url("{{ url_for('static', filename='images/programsim.png') }}");
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    input:focus::placeholder, textarea:focus::placeholder {
      color: transparent;
    }
    #posts li {
      font-size: 1.2em;
      margin-bottom: 10px;
    }
    #post-form-container input, #post-form-container textarea {
      width: 200%;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 1em;
    }
    .comment {
      border-top: 1px solid #ccc;
      padding: 5px 0;
    }
    .comment strong {
      font-size: 0.9em;
    }
    .comment-list {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<!-- ë¡œê·¸ì¸ -->
<div class="container" id="login-container">
  <h2>ì†¡í˜¸ ETA ë¡œê·¸ì¸</h2>
  <input type="text" id="login-id" placeholder="ID" />
  <input type="password" id="login-pw" placeholder="Password" />
  <button onclick="login()">ë¡œê·¸ì¸</button>
  <button onclick="showSignup()">íšŒì›ê°€ì…</button>
</div>

<!-- íšŒì›ê°€ì… -->
<div class="container" id="signup-container" style="display:none;">
  <h2>íšŒì›ê°€ì…</h2>
  <input type="text" id="signup-id" placeholder="ID (í•™ë²ˆ+ì´ë¦„)" />
  <input type="password" id="signup-pw" placeholder="Password" />
  <input type="password" id="signup-pw-confirm" placeholder="Password í™•ì¸" />
  <input type="text" id="signup-security-code" placeholder="ë³´ì•ˆì½”ë“œ ì…ë ¥" />
  <button onclick="checkDuplicate()">ì¤‘ë³µ í™•ì¸</button>
  <button onclick="register()">ê°€ì…í•˜ê¸°</button>
  <button onclick="showLogin()">ë’¤ë¡œê°€ê¸°</button>
</div>

<!-- ììœ ê²Œì‹œíŒ -->
<div class="container" id="main-container" style="display:none; position:relative;">
  <div style="position: absolute; top: -60px; right: 40px;">
    <span id="welcome-message" style="font-weight:bold;"></span>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <h2>ğŸ“‹ ììœ ê²Œì‹œíŒ</h2>
  <ul id="posts" style="margin-top: 20px;"></ul>
  <div style="text-align:right;">
    <button onclick="showPostForm()">ê¸€ì“°ê¸°</button>
  </div>
</div>

<!-- ê¸€ì“°ê¸° í¼ -->
<div class="container" id="post-form-container" style="display:none;">
  <h2>âœï¸ ê¸€ì“°ê¸°</h2>
  <input type="text" id="post-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì‹œì˜¤" />
  <textarea id="post-content" rows="8" placeholder="ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì‹œì˜¤."></textarea>
  <div style="text-align:right;">
    <button onclick="submitPost()">ì˜¬ë¦¬ê¸°</button>
    <button onclick="cancelPost()">ì·¨ì†Œ</button>
  </div>
</div>

<!-- ê´€ë¦¬ì -->
<div class="container" id="admin-container" style="display:none;">
  <h2>ê´€ë¦¬ì í˜ì´ì§€</h2>
  <div id="user-list"></div>
  <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<script>
  let posts = [];
  let comments = {};
  let currentUser = null;
  let editingPostIndex = null;

  function showOnly(id) {
    ['login-container', 'signup-container', 'main-container', 'post-form-container', 'admin-container'].forEach(eid => {
      const el = document.getElementById(eid);
      if (el) el.style.display = 'none';
    });
    const target = document.getElementById(id);
    if (target) target.style.display = 'block';
  }

  function showLogin() {
    clearInputs();
    currentUser = null;
    showOnly('login-container');
  }

  function showSignup() {
    clearInputs();
    showOnly('signup-container');
  }

  function renderPostList() {
    const container = document.getElementById('main-container');
    container.innerHTML = `
      <div style="position: absolute; top: -60px; right: 40px;">
        <span id="welcome-message" style="font-weight:bold;">${currentUser.id}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</span>
        <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
      <h2>ğŸ“‹ ììœ ê²Œì‹œíŒ</h2>
      <ul id="posts" style="margin-top: 20px;"></ul>
      <div style="text-align:right;"> 
        <button onclick="showPostForm()">ê¸€ì“°ê¸°</button>
      </div>
    `;

    const ul = document.getElementById('posts');
    ul.innerHTML = '';  // ğŸ’¡ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
    posts.forEach((post, index) => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span style="cursor:pointer;" onclick="showPostDetail(${index})">
          <strong>${post.title}</strong>
        </span> - ${post.author}
        ${(currentUser && (currentUser.role === 'admin' || post.author === currentUser.id)) ? `
          <button onclick="editPost(${index})">ìˆ˜ì •</button>
          <button onclick="deletePost(${index})">ì‚­ì œ</button>
        ` : ''}
      `;
      ul.appendChild(li);
    });
  }


  async function showPostDetail(index) {
    console.log("ì„ íƒí•œ post:", posts[index]);
    const post = posts[index];
    if (!post || !post.id) {
      console.error("post ë˜ëŠ” post.idê°€ ì—†ìŠµë‹ˆë‹¤:", post);
      alert("ì´ ê¸€ì€ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const container = document.getElementById('main-container');

    try {
      const res = await fetch('/api/get_comments?post_id=' + post.id);
      const data = await res.json();
      const postComments = data.success ? data.comments : [];

      let commentHtml = `
        <div style="margin-top:20px;">
          <textarea id="comment-input" rows="2" placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”"></textarea>
          <button onclick="addComment(${index})">ì˜¬ë¦¬ê¸°</button>
        </div>
        <div class="comment-list">
          ${postComments.map((c, i) => `
            <div class="comment">
              <strong>${c.author}:</strong> ${c.text}
              ${(currentUser && currentUser.role === 'admin') ? `
                <button onclick="deleteComment('${post.id}', ${i})">ì‚­ì œ</button>
              ` : ''}
            </div>
          `).join('')}
        </div>
        <br><button onclick="renderPostList()">ëª©ë¡ìœ¼ë¡œ</button>
      `;
      container.innerHTML = `
        <h2>ğŸ“ ${post.title}</h2>
        <p style="white-space:pre-line;">${post.content}</p>
        ${commentHtml}
      `;
    } catch (err) {
      console.error('ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
      alert('ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }
  }


  async function addComment(index) {
    const input = document.getElementById('comment-input');
    const text = input.value.trim();
    if (!text) return alert('ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

    const postId = posts[index].id;
    const res = await fetch('/api/add_comment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        post_id: postId,
        author: currentUser.id,
        text: text
      })
    });

    const data = await res.json();
    if (data.success) {
      input.value = '';
      await showPostDetail(index);  // ëŒ“ê¸€ ë‹¤ì‹œ ë¡œë”©
    } else {
      alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: ' + (data.message || ''));
    }
  }



  function clearInputs() {
    document.querySelectorAll('input, textarea').forEach(el => el.value = '');
  }

  function showPostForm() {
    clearInputs();
    editingPostIndex = null;
    showOnly('post-form-container');
  }

  async function submitPost() {
    const title = document.getElementById('post-title').value.trim();
    const content = document.getElementById('post-content').value.trim();
    if (!title || !content) return alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

    const res = await fetch('/api/add_post', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, content, author: currentUser.id })
    });

    const data = await res.json();
    if (data.success) {
      alert('ê¸€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      await loadPosts();
      showOnly('main-container');
    } else {
      alert('ê¸€ ì €ì¥ ì‹¤íŒ¨: ' + (data.message || ''));
    }
  }

  async function deleteComment(postId, index) {
    if (!confirm('ì •ë§ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const res = await fetch('/api/delete_comment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        post_id: postId,
        index: index,
        user_id: currentUser.id
      })
    });

    const data = await res.json();
    if (data.success) {
      alert('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      const postIndex = posts.findIndex(p => p.id === postId);
      if (postIndex !== -1) await showPostDetail(postIndex); // ëŒ“ê¸€ ìƒˆë¡œê³ ì¹¨
    } else {
      alert('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨: ' + (data.message || ''));
    }
  }

  function cancelPost() {
    editingPostIndex = null;
    showOnly('main-container');
  }

  function editPost(index) {
    const post = posts[index];
    if (post.author !== currentUser.id) {
      alert('ìì‹ ì˜ ê¸€ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      return;
    }
    document.getElementById('post-title').value = post.title;
    document.getElementById('post-content').value = post.content;
    editingPostIndex = index;
    showOnly('post-form-container');
  }

  async function deletePost(index) {
    const post = posts[index];
    if (post.author !== currentUser.id && currentUser.role !== 'admin') {
      alert('ìì‹ ì˜ ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      return;
    }
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const res = await fetch('/api/delete_post', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ post_id: post.id, user_id: currentUser.id })
    });

    const data = await res.json();
    if (data.success) {
      alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      await loadPosts();
    } else {
      alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
    }
  }

  async function login() {
    const id = document.getElementById('login-id').value.trim();
    const pw = document.getElementById('login-pw').value;
    if (!id || !pw) return alert('IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, password: pw })
    });

    const data = await res.json();
    if (data.success) {
      currentUser = { id: id, role: data.role };
      document.getElementById('welcome-message').innerText = `${currentUser.id}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;

      await loadPosts();
      showOnly('main-container');

      if (currentUser.role === 'admin') {
        document.getElementById('admin-container').style.display = 'block';
        await renderAdmin(id);
      }
    } else {
      alert(data.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
    }
  }

  async function renderAdmin(adminId) {
    const res = await fetch('/api/get_users', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: adminId })
    });

    const data = await res.json();
    if (data.success) {
      const container = document.getElementById('user-list');
      container.innerHTML = '';
      data.users.forEach(user => {
        const div = document.createElement('div');
        div.textContent = user.id + ' ';
        const btn = document.createElement('button');
        btn.textContent = 'ì‚­ì œ';
        btn.onclick = () => deleteUser(user.id, adminId);
        div.appendChild(btn);
        container.appendChild(div);
      });

      document.getElementById('admin-container').style.display = 'block';
    } else {
      alert(data.message);
    }
  }

  function logout() {
    currentUser = null;
    showLogin();
  }

  async function loadPosts() {
    const res = await fetch('/api/get_posts');
    const data = await res.json();
    if (data.success) {
      posts = Object.entries(data.posts).map(([id, post]) => ({
        ...post,
        id
      }));
      renderPostList();
    }
  }
</script>
</body>
</html>

